name: Build and Release

on:
  workflow_dispatch:
  push:
    tags:
      - '*'

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  QT_VERSION: '6.10.0'
  LUA_VERSION: '5.4.7'
  OPENSSL_VERSION: '3.4.1'
  LIBGIT2_VERSION: '1.9.0'

jobs:
  # ─────────────────────────────────────────────
  # macOS Universal (arm64 + x86_64)
  # ─────────────────────────────────────────────
  build-macos:
    name: macOS Universal
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install build tools
        run: brew install swig

      - name: Install Qt
        id: qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{env.QT_VERSION}}
          host: 'mac'
          target: 'desktop'
          arch: 'clang_64'
          modules: 'qtmultimedia qtshadertools'
      - name: Resolve Qt prefix
        shell: bash
        run: |
          QT_PREFIX="${{ steps.qt.outputs.qt_dir }}"
          if [ -z "$QT_PREFIX" ]; then QT_PREFIX="${{ steps.qt.outputs.dir }}"; fi
          if [ -z "$QT_PREFIX" ] && [ -n "${QT_ROOT_DIR}" ]; then QT_PREFIX="${QT_ROOT_DIR}"; fi
          if [ -z "$QT_PREFIX" ] && [ -n "${Qt6_DIR}" ]; then
            QT_PREFIX="$(cd "${Qt6_DIR}/../../.." && pwd)"
          fi
          if [ -z "$QT_PREFIX" ]; then
            echo "QT_PREFIX not found" >&2
            exit 1
          fi
          echo "QT_PREFIX=${QT_PREFIX}" >> "$GITHUB_ENV"

      - name: Cache native dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: /tmp/deps
          key: macos-deps-lua${{env.LUA_VERSION}}-ssl${{env.OPENSSL_VERSION}}-git2${{env.LIBGIT2_VERSION}}-v2

      - name: Build Lua (universal)
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          cd ..
          curl -LO https://www.lua.org/ftp/lua-${{env.LUA_VERSION}}.tar.gz
          tar xf lua-${{env.LUA_VERSION}}.tar.gz
          cd lua-${{env.LUA_VERSION}}
          make macosx MYCFLAGS="-arch arm64 -arch x86_64" MYLDFLAGS="-arch arm64 -arch x86_64" -j$(sysctl -n hw.ncpu)
          make install INSTALL_TOP=/tmp/deps

      - name: Build OpenSSL (universal)
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          cd ..
          curl -LO https://github.com/openssl/openssl/releases/download/openssl-${{env.OPENSSL_VERSION}}/openssl-${{env.OPENSSL_VERSION}}.tar.gz
          tar xf openssl-${{env.OPENSSL_VERSION}}.tar.gz

          cp -r openssl-${{env.OPENSSL_VERSION}} openssl-arm64
          cd openssl-arm64
          ./Configure darwin64-arm64 no-tests --prefix=/tmp/openssl-arm64
          make -j$(sysctl -n hw.ncpu) && make install_sw
          cd ..

          cp -r openssl-${{env.OPENSSL_VERSION}} openssl-x86_64
          cd openssl-x86_64
          ./Configure darwin64-x86_64 no-tests --prefix=/tmp/openssl-x86_64
          make -j$(sysctl -n hw.ncpu) && make install_sw
          cd ..

          mkdir -p /tmp/deps/ssl/lib
          cp -r /tmp/openssl-arm64/include /tmp/deps/ssl/
          lipo -create /tmp/openssl-arm64/lib/libcrypto.a /tmp/openssl-x86_64/lib/libcrypto.a \
            -output /tmp/deps/ssl/lib/libcrypto.a
          lipo -create /tmp/openssl-arm64/lib/libssl.a /tmp/openssl-x86_64/lib/libssl.a \
            -output /tmp/deps/ssl/lib/libssl.a

      - name: Build libgit2 (universal)
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          cd ..
          git clone https://github.com/libgit2/libgit2
          cd libgit2
          git checkout v${{env.LIBGIT2_VERSION}}
          mkdir build && cd build
          cmake .. \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_TESTS=OFF \
            -DBUILD_CLI=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/tmp/deps \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DOPENSSL_ROOT_DIR=/tmp/deps/ssl
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Install cached deps to system
        run: |
          sudo mkdir -p /usr/local/lib /usr/local/include
          sudo cp -a /tmp/deps/lib/* /usr/local/lib/
          sudo cp -a /tmp/deps/include/* /usr/local/include/
          if [ -d /tmp/deps/lib/pkgconfig ]; then
            sudo mkdir -p /usr/local/lib/pkgconfig
            sudo cp -a /tmp/deps/lib/pkgconfig/* /usr/local/lib/pkgconfig/
          fi

      - name: Configure
        run: |
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
                -DCMAKE_PREFIX_PATH="${QT_PREFIX}" \
                -DOPENSSL_ROOT_DIR=/tmp/deps/ssl \
                -B build

      - name: Build
        run: make -j$(sysctl -n hw.ncpu) -C build

      - name: Package
        run: |
          mkdir -p HeroKill-macOS
          cp -r build/HeroKill.app HeroKill-macOS/
          cd HeroKill-macOS
          RES_DIR="HeroKill.app/Contents/Resources"
          mkdir -p "$RES_DIR"
          cp -R ../audio ../fonts ../image ../packages ../client "$RES_DIR"
          if [ -d ../lua ]; then cp -R ../lua "$RES_DIR"; fi
          if [ -f ../waiting_tips.txt ]; then cp ../waiting_tips.txt "$RES_DIR"; fi
          cp ../fk_ver "$RES_DIR"
          # install-qt-action@v4 已将 Qt bin 目录加入 PATH
          macdeployqt HeroKill.app -qmldir="$RES_DIR"
          cp ../fk_ver HeroKill.app/Contents/MacOS/
          cd ..
          hdiutil create -volname HeroKill -srcfolder HeroKill-macOS -ov -format UDZO \
            HeroKill-${{github.ref_name}}-macOS.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: HeroKill-${{github.ref_name}}-macOS.dmg

  # ─────────────────────────────────────────────
  # Windows x64
  # ─────────────────────────────────────────────
  build-windows:
    name: Windows x64
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install swig
        run: choco install swig -y

      - name: Install Qt
        id: qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{env.QT_VERSION}}
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw'
          modules: 'qtmultimedia qtshadertools'
          tools: 'tools_opensslv3_x64 tools_mingw1310'
      - name: Resolve Qt prefix
        shell: bash
        run: |
          QT_PREFIX="${{ steps.qt.outputs.qt_dir }}"
          if [ -z "$QT_PREFIX" ]; then QT_PREFIX="${{ steps.qt.outputs.dir }}"; fi
          if [ -z "$QT_PREFIX" ] && [ -n "${QT_ROOT_DIR}" ]; then QT_PREFIX="${QT_ROOT_DIR}"; fi
          if [ -z "$QT_PREFIX" ] && [ -n "${Qt6_DIR}" ]; then
            QT_PREFIX="$(cd "${Qt6_DIR}/../../.." && pwd)"
          fi
          if [ -z "$QT_PREFIX" ]; then
            echo "QT_PREFIX not found" >&2
            exit 1
          fi
          echo "QT_PREFIX=${QT_PREFIX}" >> "$GITHUB_ENV"

      - name: Disable PCH
        shell: bash
        run: |
          cd src
          find -name "*.cpp" -exec sed -i '1i #include "pch.h"' "{}" \;
          find -name "*.h" -exec sed -i '1i #include "pch.h"' "{}" \;
          sed -i '1d' pch.h
          sed -i '1d' main.cpp
          sed -i '/pch.h/d' CMakeLists.txt

      - name: Configure
        shell: bash
        run: |
          MINGW_DIR="${QT_PREFIX}/../../Tools/mingw1310_64/bin"
          OPENSSL_DIR="${QT_PREFIX}/../../Tools/OpenSSLv3/Win_x64"
          export CC="${MINGW_DIR}/gcc.exe"
          export CXX="${MINGW_DIR}/g++.exe"
          export RC="${MINGW_DIR}/windres.exe"
          OPENSSL_CRYPTO_LIB=""
          OPENSSL_SSL_LIB=""
          for f in \
            "${OPENSSL_DIR}/lib/libcrypto.a" \
            "${OPENSSL_DIR}/lib/libcrypto-3-x64.dll.a" \
            "${OPENSSL_DIR}/lib/libcrypto.dll.a" \
            "${OPENSSL_DIR}/bin/libcrypto-3-x64.dll"; do
            if [ -f "$f" ]; then OPENSSL_CRYPTO_LIB="$f"; break; fi
          done
          for f in \
            "${OPENSSL_DIR}/lib/libssl.a" \
            "${OPENSSL_DIR}/lib/libssl-3-x64.dll.a" \
            "${OPENSSL_DIR}/lib/libssl.dll.a" \
            "${OPENSSL_DIR}/bin/libssl-3-x64.dll"; do
            if [ -f "$f" ]; then OPENSSL_SSL_LIB="$f"; break; fi
          done
          if [ -z "$OPENSSL_CRYPTO_LIB" ] || [ -z "$OPENSSL_SSL_LIB" ]; then
            echo "OpenSSL libraries not found under ${OPENSSL_DIR}" >&2
            exit 1
          fi
          cmake -DCMAKE_BUILD_TYPE=MinSizeRel \
                -DCMAKE_PREFIX_PATH="${QT_PREFIX}" \
                -DOPENSSL_ROOT_DIR="${OPENSSL_DIR}" \
                -DOPENSSL_INCLUDE_DIR="${OPENSSL_DIR}/include" \
                -DOPENSSL_CRYPTO_LIBRARY="${OPENSSL_CRYPTO_LIB}" \
                -DOPENSSL_SSL_LIBRARY="${OPENSSL_SSL_LIB}" \
                -G "MinGW Makefiles" -B build

      - name: Build
        working-directory: build
        run: mingw32-make -j4

      - name: Package
        shell: bash
        run: |
          mkdir HeroKill-release
          cp build/HeroKill.exe HeroKill-release
          cd HeroKill-release
          windeployqt HeroKill.exe
          cd ..
          cp lib/win/* HeroKill-release
          cp fk_ver HeroKill-release
          cp "${QT_PREFIX}/bin"/li*.dll HeroKill-release
          cp "${QT_PREFIX}/../../Tools/OpenSSLv3/Win_x64/bin"/*.dll HeroKill-release
          7z a -t7z HeroKill-${{github.ref_name}}-Windows.7z HeroKill-release -r -mx=9 -m0=LZMA2 -ms=10m -mf=on -mhc=on -mmt=on

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: HeroKill-${{github.ref_name}}-Windows.7z

  # ─────────────────────────────────────────────
  # Android arm64-v8a
  # ─────────────────────────────────────────────
  build-android:
    name: Android arm64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Android SDK/NDK
        run: |
          cd ..
          mkdir android && cd android
          wget --quiet https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip commandlinetools-linux-9477386_latest.zip
          yes | ./cmdline-tools/bin/sdkmanager --sdk_root=$(pwd) \
            "platforms;android-35" \
            "platform-tools" \
            "build-tools;35.0.0" \
            "ndk;27.2.12479018"

      - name: Setup OpenSSL for Android
        run: |
          cd ..
          wget --quiet https://github.com/openssl/openssl/releases/download/openssl-3.1.8/openssl-3.1.8.tar.gz
          tar xf openssl-3.1.8.tar.gz
          cd openssl-3.1.8
          git clone https://github.com/KDAB/android_openssl
          rm -rf include
          cp -r android_openssl/ssl_3/include .
          cp -r android_openssl/ssl_3/arm64-v8a/libcrypto_3.so .
          cp -r android_openssl/ssl_3/arm64-v8a/libssl_3.so .
          cd ../hero-kill-game-client
          cp -r ../openssl-3.1.8/include/openssl ./include

      - name: Build libgit2 for Android
        run: |
          cd ..
          git clone https://github.com/libgit2/libgit2
          cd libgit2
          git checkout v${{env.LIBGIT2_VERSION}}
          mkdir build && cd build
          export ANDROID_SDK_ROOT=$(pwd)/../../android
          export ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/27.2.12479018
          PATH=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          SSL_DIR=$(pwd)/../../openssl-3.1.8
          cmake .. \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_TESTS=OFF \
            -DBUILD_CLI=OFF \
            -DCMAKE_SYSTEM_NAME=Android \
            -DCMAKE_SYSTEM_VERSION=29 \
            -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
            -DCMAKE_ANDROID_NDK=${ANDROID_NDK_ROOT} \
            -DOPENSSL_INCLUDE_DIR="${SSL_DIR}/include" \
            -DOPENSSL_CRYPTO_LIBRARY="${SSL_DIR}/libcrypto_3.so" \
            -DOPENSSL_SSL_LIBRARY="${SSL_DIR}/libssl_3.so"
          make -j$(nproc)
          cp libgit2.so ${SSL_DIR}

      - name: Install swig
        run: sudo apt-get install -y swig

      - name: Install Qt (Host)
        id: qt-host
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{env.QT_VERSION}}
          host: 'linux'
          target: 'desktop'
          arch: 'linux_gcc_64'
          modules: 'qtmultimedia qtshadertools'

      - name: Install Qt (Android)
        id: qt-android
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{env.QT_VERSION}}
          host: 'linux'
          target: 'android'
          arch: 'android_arm64_v8a'
          modules: 'qtmultimedia qtshadertools'
      - name: Resolve Qt prefixes
        shell: bash
        run: |
          QT_ANDROID_PREFIX="${{ steps.qt-android.outputs.qt_dir }}"
          if [ -z "$QT_ANDROID_PREFIX" ]; then QT_ANDROID_PREFIX="${{ steps.qt-android.outputs.dir }}"; fi
          if [ -z "$QT_ANDROID_PREFIX" ] && [ -n "${QT_ROOT_DIR}" ]; then QT_ANDROID_PREFIX="${QT_ROOT_DIR}"; fi
          if [ -z "$QT_ANDROID_PREFIX" ] && [ -n "${Qt6_DIR}" ]; then
            QT_ANDROID_PREFIX="$(cd "${Qt6_DIR}/../../.." && pwd)"
          fi
          if [ -z "$QT_ANDROID_PREFIX" ]; then
            echo "QT_ANDROID_PREFIX not found" >&2
            exit 1
          fi

          QT_HOST_PREFIX="${{ steps.qt-host.outputs.qt_dir }}"
          if [ -z "$QT_HOST_PREFIX" ]; then QT_HOST_PREFIX="${{ steps.qt-host.outputs.dir }}"; fi
          if [ -z "$QT_HOST_PREFIX" ] && [ -n "${QT_HOST_PATH}" ]; then QT_HOST_PREFIX="${QT_HOST_PATH}"; fi
          if [ -z "$QT_HOST_PREFIX" ] && [ -d "$(dirname "$QT_ANDROID_PREFIX")/gcc_64" ]; then
            QT_HOST_PREFIX="$(cd "$(dirname "$QT_ANDROID_PREFIX")/gcc_64" && pwd)"
          fi
          if [ -z "$QT_HOST_PREFIX" ]; then
            echo "QT_HOST_PREFIX not found" >&2
            exit 1
          fi

          echo "QT_PREFIX=${QT_ANDROID_PREFIX}" >> "$GITHUB_ENV"
          echo "QT_HOST_PATH=${QT_HOST_PREFIX}" >> "$GITHUB_ENV"

      - name: Prepare Android assets
        run: |
          FKVER=$(cat CMakeLists.txt | grep 'project(HeroKill' | cut -d ' ' -f 3)
          cd android
          sed -i 's/function //g' copy_assets.sh
          ./copy_assets.sh || true
          cd assets/res
          cp -r /etc/ssl/certs .
          cp /usr/share/ca-certificates/mozilla/* certs/
          cd ../..
          echo ${FKVER%)} > ../fk_ver
          ../genfkver.sh
          cp ../fk_ver assets/res

      - name: Configure
        run: |
          # Qt6_DIR = <prefix>/lib/cmake/Qt6, 反推 Qt 前缀目录
          QT_PREFIX="${QT_PREFIX}"
          export QT_HOST_PATH="${QT_HOST_PATH}"
          export ANDROID_SDK_ROOT=$(pwd)/../android
          export ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/27.2.12479018
          export FK_ANDROID_SSL_DIR=$(pwd)/../openssl-3.1.8
          sed -i "s/LinguistTools/Linguist/g" CMakeLists.txt
          "${QT_PREFIX}/bin/qt-cmake" -S . -B ./build -DCMAKE_BUILD_TYPE=MinSizeRel

      - name: Build
        run: make -j2 -C build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: build/android-build/build/outputs/apk/release/android-build-release-unsigned.apk

  # ─────────────────────────────────────────────
  # Unified Release
  # ─────────────────────────────────────────────
  release:
    name: Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-macos, build-windows, build-android]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup Android SDK for signing
        uses: android-actions/setup-android@v3

      - name: Sign Android APK
        shell: bash
        run: |
          # build-tools 不在 PATH 中，需要手动添加
          BUILD_TOOLS_DIR=$(ls -d "$ANDROID_HOME"/build-tools/*/ | sort -V | tail -1)
          export PATH="${BUILD_TOOLS_DIR}:$PATH"

          if [ -z "${{ secrets.KEY_STORE }}" ]; then
            echo "Missing KEY_STORE secret" >&2
            exit 1
          fi
          if [ -z "${{ secrets.KEY_STORE_ALIAS }}" ]; then
            echo "Missing KEY_STORE_ALIAS secret" >&2
            exit 1
          fi
          if [ -z "${{ secrets.KEY_STORE_PASSWORD }}" ]; then
            echo "Missing KEY_STORE_PASSWORD secret" >&2
            exit 1
          fi

          KEYSTORE_B64=$(printf '%s' "${{ secrets.KEY_STORE }}" | tr -d '\r\n ')
          if ! printf '%s' "${KEYSTORE_B64}" | base64 --decode > keystore.jks; then
            echo "KEY_STORE is not valid base64. Re-create with: base64 -w0 keystore.jks" >&2
            exit 1
          fi
          APK=$(find artifacts/android -name '*.apk' | head -1)
          if [ -z "$APK" ]; then
            echo "No APK found under artifacts/android" >&2
            exit 1
          fi
          zipalign -v -p 4 "$APK" aligned.apk
          apksigner sign \
            --ks keystore.jks \
            --ks-key-alias "${{ secrets.KEY_STORE_ALIAS }}" \
            --ks-pass "pass:${{ secrets.KEY_STORE_PASSWORD }}" \
            --out "artifacts/android/signed.apk" \
            aligned.apk
          rm -f keystore.jks aligned.apk

      - name: Prepare release files
        run: |
          mkdir release
          cp artifacts/macos/*.dmg release/
          cp artifacts/windows/*.7z release/
          mv artifacts/android/signed.apk \
            release/HeroKill-${{github.ref_name}}-Android.apk

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.MY_TOKEN }}
          tag_name: ${{github.ref_name}}
          name: HeroKill ${{github.ref_name}}
          generate_release_notes: true
          files: release/*
