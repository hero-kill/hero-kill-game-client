name: Build For macOS

on:
  workflow_dispatch:
  push:
    tags:
      - '*'

jobs:
  build:
    name: Build macOS Universal
    runs-on: macos-14

    steps:
      - name: Checkout Git Repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install build tools
        run: brew install swig

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          aqtversion: '==3.1.*'
          py7zrversion: '>=0.20.2'
          version: '6.10.0'
          host: 'mac'
          target: 'desktop'
          arch: 'clang_64'
          modules: 'qtmultimedia qtshadertools'

      - name: Build Lua 5.4 (universal)
        run: |
          cd ..
          curl -LO https://www.lua.org/ftp/lua-5.4.7.tar.gz
          tar xf lua-5.4.7.tar.gz
          cd lua-5.4.7
          make macosx MYCFLAGS="-arch arm64 -arch x86_64" MYLDFLAGS="-arch arm64 -arch x86_64" -j$(sysctl -n hw.ncpu)
          sudo make install

      - name: Build OpenSSL 3 (universal)
        env:
          OPENSSL_VER: '3.4.1'
        run: |
          cd ..
          curl -LO https://github.com/openssl/openssl/releases/download/openssl-${OPENSSL_VER}/openssl-${OPENSSL_VER}.tar.gz
          tar xf openssl-${OPENSSL_VER}.tar.gz

          # Build arm64
          cp -r openssl-${OPENSSL_VER} openssl-arm64
          cd openssl-arm64
          ./Configure darwin64-arm64 no-tests --prefix=/tmp/openssl-arm64
          make -j$(sysctl -n hw.ncpu) && make install_sw
          cd ..

          # Build x86_64
          cp -r openssl-${OPENSSL_VER} openssl-x86_64
          cd openssl-x86_64
          ./Configure darwin64-x86_64 no-tests --prefix=/tmp/openssl-x86_64
          make -j$(sysctl -n hw.ncpu) && make install_sw
          cd ..

          # Create universal libraries
          OPENSSL_UNIVERSAL=/tmp/openssl-universal
          mkdir -p ${OPENSSL_UNIVERSAL}/lib
          cp -r /tmp/openssl-arm64/include ${OPENSSL_UNIVERSAL}/
          lipo -create /tmp/openssl-arm64/lib/libcrypto.a /tmp/openssl-x86_64/lib/libcrypto.a \
            -output ${OPENSSL_UNIVERSAL}/lib/libcrypto.a
          lipo -create /tmp/openssl-arm64/lib/libssl.a /tmp/openssl-x86_64/lib/libssl.a \
            -output ${OPENSSL_UNIVERSAL}/lib/libssl.a

      - name: Build and install libgit2 1.9.0 (universal)
        run: |
          cd ..
          git clone https://github.com/libgit2/libgit2
          cd libgit2
          git checkout v1.9.0
          mkdir build
          cd build
          cmake .. \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_TESTS=OFF \
            -DBUILD_CLI=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DOPENSSL_ROOT_DIR=/tmp/openssl-universal
          make -j$(sysctl -n hw.ncpu)
          sudo make install

      - name: Configure CMake Project
        working-directory: ${{github.workspace}}
        run: |
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
                -DCMAKE_PREFIX_PATH=${{env.Qt6_Dir}} \
                -DOPENSSL_ROOT_DIR=/tmp/openssl-universal \
                -B ${{github.workspace}}/build

      - name: Build project
        working-directory: ${{github.workspace}}/build
        run: make -j$(sysctl -n hw.ncpu)

      - name: Package Application
        working-directory: ${{github.workspace}}
        run: |
          mkdir -p HeroKill-macOS
          cp -r build/HeroKill.app HeroKill-macOS/
          cd HeroKill-macOS
          ${{env.Qt6_Dir}}/bin/macdeployqt HeroKill.app
          cp ../fk_ver HeroKill.app/Contents/MacOS/
          cd ..
          hdiutil create -volname HeroKill -srcfolder HeroKill-macOS -ov -format UDZO HeroKill-macOS.dmg

      - name: Upload Release
        uses: actions/upload-artifact@v4
        with:
          name: dmg-universal
          path: HeroKill-macOS.dmg

  release:
    name: Release DMG
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Git Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Previous tag
        id: previoustag
        uses: WyriHaximus/github-action-get-previous-tag@v1
        with:
          fallback: 0.0.1

      - name: Download DMG from build
        uses: actions/download-artifact@v4
        with:
          name: dmg-universal
          path: dmg

      - name: Rename DMG file
        run: |
          mv dmg/HeroKill-macOS.dmg dmg/HeroKill-${{ steps.previoustag.outputs.tag }}-macOS.dmg

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.MY_TOKEN }}
          tag_name: ${{ steps.previoustag.outputs.tag }}
          files: dmg/HeroKill-${{ steps.previoustag.outputs.tag }}-macOS.dmg
